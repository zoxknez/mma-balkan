name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
  push:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # Deploy Frontend to Vercel
  deploy-frontend:
    name: Deploy Frontend (Vercel)
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment
        run: |
          vercel pull --yes --environment=${{ github.event.inputs.environment || 'production' }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project
        run: |
          vercel build ${{ github.event.inputs.environment == 'production' && '--prod' || '' }} --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        run: |
          vercel deploy ${{ github.event.inputs.environment == 'production' && '--prod' || '--prebuilt' }} --token=${{ secrets.VERCEL_TOKEN }}

  # Deploy Backend to Railway
  deploy-backend:
    name: Deploy Backend (Railway)
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          railway up --service backend --environment ${{ github.event.inputs.environment || 'production' }}

      - name: Run database migrations
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          railway run --service backend npm run prisma:migrate

  # Health check after deployment
  health-check:
    name: Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    steps:
      - name: Check frontend health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.FRONTEND_URL }})
          if [ $response -ne 200 ]; then
            echo "Frontend health check failed: $response"
            exit 1
          fi

      - name: Check backend health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.BACKEND_URL }}/healthz)
          if [ $response -ne 200 ]; then
            echo "Backend health check failed: $response"
            exit 1
          fi

      - name: Run smoke tests
        run: |
          curl -f ${{ secrets.FRONTEND_URL }}/fighters || exit 1
          curl -f ${{ secrets.BACKEND_URL }}/api/fighters || exit 1

  # Rollback on failure
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: health-check
    if: failure() && github.event.inputs.environment == 'production'
    steps:
      - name: Trigger rollback
        run: |
          echo "Health check failed - rolling back deployment"
          # TODO: Add rollback commands for Vercel and Railway

      - name: Notify team
        run: |
          echo "Deployment failed - team notified"
          # TODO: Add Slack/Discord notification

